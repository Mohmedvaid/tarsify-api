// Prisma Schema for Tarsify AI Marketplace
// Based on INFRA.MD specifications

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CONSUMER MODELS (Firebase Project A users)
// ============================================

/// Consumer - End users who browse and run AI notebooks
model Consumer {
  id             String   @id @default(uuid()) @db.Uuid
  firebaseUid    String   @unique @map("firebase_uid")
  email          String   @unique
  name           String?
  avatarUrl      String?  @map("avatar_url")
  creditsBalance Int      @default(0) @map("credits_balance")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  purchases  Purchase[]
  executions Execution[]  // Engine executions (new)

  @@map("consumers")
}

// ============================================
// DEVELOPER MODELS (Firebase Project B users)
// ============================================

/// Developer - Users who create and sell AI notebooks
model Developer {
  id              String   @id @default(uuid()) @db.Uuid
  firebaseUid     String   @unique @map("firebase_uid")
  email           String   @unique
  name            String?
  avatarUrl       String?  @map("avatar_url")
  earningsBalance Int      @default(0) @map("earnings_balance") // In cents
  payoutEmail     String?  @map("payout_email")
  stripeAccountId String?  @map("stripe_account_id")
  verified        Boolean  @default(false)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  notebooks  Notebook[]
  payouts    Payout[]
  tarsModels TarsModel[]  // Engine tars models

  @@map("developers")
}

// ============================================
// NOTEBOOK MODELS
// ============================================

/// GPU types available for notebook execution
enum GpuType {
  T4
  L4
  A100
  H100
}

/// Notebook publication status
enum NotebookStatus {
  draft
  published
  archived
}

/// Notebook categories
enum NotebookCategory {
  image
  text
  video
  audio
  other
}

/// Notebook - AI mini-apps created by developers
model Notebook {
  id               String           @id @default(uuid()) @db.Uuid
  developerId      String           @map("developer_id") @db.Uuid
  title            String
  description      String?          @db.Text
  shortDescription String?          @map("short_description") @db.VarChar(255)
  thumbnailUrl     String?          @map("thumbnail_url")
  priceCredits     Int              @map("price_credits")
  gpuType          GpuType          @map("gpu_type")
  category         NotebookCategory @default(other)
  status           NotebookStatus   @default(draft)
  totalRuns        Int              @default(0) @map("total_runs")
  averageRating    Decimal?         @map("average_rating") @db.Decimal(3, 2)
  notebookFileUrl  String?          @map("notebook_file_url")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  developer Developer @relation(fields: [developerId], references: [id], onDelete: Cascade)

  @@index([developerId])
  @@index([status])
  @@index([category])
  @@map("notebooks")
}

// ============================================
// TRANSACTION MODELS
// ============================================

/// Purchase - Credit purchases by consumers
model Purchase {
  id              String   @id @default(uuid()) @db.Uuid
  consumerId      String   @map("consumer_id") @db.Uuid
  creditsAmount   Int      @map("credits_amount")
  amountPaid      Int      @map("amount_paid") // In cents
  stripePaymentId String?  @map("stripe_payment_id")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  consumer Consumer @relation(fields: [consumerId], references: [id], onDelete: Cascade)

  @@index([consumerId])
  @@map("purchases")
}

// ============================================
// ENGINE MODELS (RunPod Integration)
// ============================================

/// Source of RunPod endpoint
enum EndpointSource {
  HUB
  CUSTOM
}

/// Model categories
enum ModelCategory {
  IMAGE
  AUDIO
  TEXT
  VIDEO
  DOCUMENT
}

/// Output types from models
enum OutputType {
  IMAGE
  AUDIO
  TEXT
  FILE
  JSON
}

/// Tars model publication status
enum TarsModelStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

/// Engine execution status
enum EngineExecutionStatus {
  PENDING
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  TIMED_OUT
  CANCELLED
}

/// RunpodEndpoint - Platform-managed RunPod endpoints
model RunpodEndpoint {
  id               String         @id @default(uuid()) @db.Uuid
  runpodEndpointId String         @unique @map("runpod_endpoint_id")
  name             String         @db.VarChar(100)
  source           EndpointSource @default(HUB)
  dockerImage      String?        @map("docker_image")
  gpuType          String         @map("gpu_type") @db.VarChar(50)
  isActive         Boolean        @default(true) @map("is_active")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  // Relations
  baseModels BaseModel[]
  executions Execution[]

  @@map("runpod_endpoints")
}

/// BaseModel - AI capabilities developers can build on
model BaseModel {
  id               String        @id @default(uuid()) @db.Uuid
  endpointId       String        @map("endpoint_id") @db.Uuid
  endpoint         RunpodEndpoint @relation(fields: [endpointId], references: [id])
  slug             String        @unique @db.VarChar(100)
  name             String        @db.VarChar(200)
  description      String?       @db.Text
  category         ModelCategory
  inputSchema      Json          @map("input_schema")
  outputType       OutputType    @map("output_type")
  outputFormat     String        @map("output_format") @db.VarChar(20)
  estimatedSeconds Int           @default(30) @map("estimated_seconds")
  isActive         Boolean       @default(true) @map("is_active")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  // Relations
  tarsModels TarsModel[]

  @@map("base_models")
}

/// TarsModel - Developer-configured models for marketplace
model TarsModel {
  id              String          @id @default(uuid()) @db.Uuid
  developerId     String          @map("developer_id") @db.Uuid
  developer       Developer       @relation(fields: [developerId], references: [id])
  baseModelId     String          @map("base_model_id") @db.Uuid
  baseModel       BaseModel       @relation(fields: [baseModelId], references: [id])
  title           String          @db.VarChar(200)
  slug            String          @unique @db.VarChar(200)
  description     String?         @db.Text
  configOverrides Json?           @map("config_overrides")
  status          TarsModelStatus @default(DRAFT)
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  publishedAt     DateTime?       @map("published_at")

  // Relations
  executions Execution[]

  @@index([developerId])
  @@index([status])
  @@map("tars_models")
}

/// Execution - Consumer job runs via engine
model Execution {
  id              String                @id @default(uuid()) @db.Uuid
  consumerId      String                @map("consumer_id") @db.Uuid
  consumer        Consumer              @relation(fields: [consumerId], references: [id])
  tarsModelId     String                @map("tars_model_id") @db.Uuid
  tarsModel       TarsModel             @relation(fields: [tarsModelId], references: [id])
  endpointId      String                @map("endpoint_id") @db.Uuid
  endpoint        RunpodEndpoint        @relation(fields: [endpointId], references: [id])
  status          EngineExecutionStatus @default(PENDING)
  runpodJobId     String?               @unique @map("runpod_job_id")
  inputPayload    Json?                 @map("input_payload")
  outputPayload   Json?                 @map("output_payload")
  errorMessage    String?               @map("error_message") @db.Text
  errorCode       String?               @map("error_code") @db.VarChar(50)
  createdAt       DateTime              @default(now()) @map("created_at")
  completedAt     DateTime?             @map("completed_at")
  executionTimeMs Int?                  @map("execution_time_ms")

  @@index([consumerId, createdAt(sort: Desc)])
  @@index([tarsModelId])
  @@index([status])
  @@index([runpodJobId])
  @@map("executions")
}

/// Payout status
enum PayoutStatus {
  pending
  processing
  completed
  failed
}

/// Payout - Developer withdrawals
model Payout {
  id             String       @id @default(uuid()) @db.Uuid
  developerId    String       @map("developer_id") @db.Uuid
  amount         Int // In cents
  status         PayoutStatus @default(pending)
  stripePayoutId String?      @map("stripe_payout_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  completedAt    DateTime?    @map("completed_at")

  // Relations
  developer Developer @relation(fields: [developerId], references: [id], onDelete: Cascade)

  @@index([developerId])
  @@index([status])
  @@map("payouts")
}
